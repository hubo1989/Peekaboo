//
//  InspectorWindow.swift
//  Peekaboo
//
//  Simplified Inspector window for debugging

import AppKit
import SwiftUI

struct InspectorWindow: View {
    @Environment(Permissions.self) private var permissions

    var body: some View {
        InspectorView()
            .frame(minWidth: 400, minHeight: 600)
            .background(WindowAccessor(windowAction: { window in
                // Ensure this is a proper window, not a panel
                window.styleMask = [.titled, .closable, .miniaturizable, .resizable]
                window.level = .normal
                window.collectionBehavior = [.managed, .participatesInCycle]
                window.isMovableByWindowBackground = false
                window.titlebarAppearsTransparent = false
                window.standardWindowButton(.closeButton)?.isEnabled = true
                window.standardWindowButton(.miniaturizeButton)?.isEnabled = true
                window.standardWindowButton(.zoomButton)?.isEnabled = true

                // CRITICAL: Accept mouse events for local monitor to work
                window.ignoresMouseEvents = false

                // Set window identifier for debugging
                window.identifier = NSUserInterfaceItemIdentifier("inspector")

                // Note: Don't call makeKeyAndOrderFront here as it forces the window to appear
                // The window should only appear when explicitly opened via menu/shortcut
            }))
            .onAppear {
                Task {
                    await self.permissions.check()
                }
            }
    }
}

// Window accessor to configure NSWindow properties
struct WindowAccessor: NSViewRepresentable {
    let windowAction: (NSWindow) -> Void

    func makeNSView(context: Context) -> NSView {
        let view = NSView()
        return view
    }

    func updateNSView(_ nsView: NSView, context: Context) {
        guard let window = nsView.window else { return }
        guard !context.coordinator.hasConfigured else { return }
        context.coordinator.hasConfigured = true

        DispatchQueue.main.asyncAfter(deadline: .now() + 0.1) {
            self.windowAction(window)
        }
    }

    func makeCoordinator() -> Coordinator {
        Coordinator()
    }

    class Coordinator {
        var hasConfigured = false
    }
}

#Preview {
    InspectorWindow()
        .environment(PeekabooSettings())
        .environment(Permissions())
}
